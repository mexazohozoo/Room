<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KILLER_VOIDS Â· Chat Hitam Ungu</title>
    <!-- Firebase SDK (modular) -->
    <script type="module">
        // Import Firebase modular
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, where, updateDoc, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { getStorage, ref, uploadString, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js';
        import { getDatabase, ref as dbRef, onDisconnect, set, onValue, push, serverTimestamp as rtServerTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        // ================== KONFIGURASI FIREBASE LOE ==================
        // GANTI PAKAI PUNYA LOE (dapet dari console.firebase.google.com)
        const firebaseConfig = {
            apiKey: "AIzaSyAyv_LVzK9uWFzEpGe1zKNPUH8DWjOXrx4",           // <-- GANTI
            authDomain: "hozoroom.firebaseapp.com",   // <-- GANTI
            projectId: "hozoroom",                     // <-- GANTI
            storageBucket: "hozoroom.firebasestorage.app",     // <-- GANTI
            messagingSenderId: "1:26873718921:web:40b59a1c721043b61fbe58",            // <-- GANTI
            appId: "G-8ZJ1ZWD1ZN"         // <-- GANTI
        };
        // ============================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);            // Firestore buat pesan & user profile
        const rtdb = getDatabase(app);            // Realtime DB buat status online
        const storage = getStorage(app);          // Storage buat foto profil

        // Global variables
        let currentUser = {
            uid: null,
            name: null,
            photoURL: null
        };
        let unsubMessages = null;
        let unsubOnline = null;
        let onlineCountRef = null;

        // Elemen DOM
        const loginContainer = document.getElementById('loginContainer');
        const chatContainer = document.getElementById('chatContainer');
        const loginBtn = document.getElementById('loginBtn');
        const usernameInput = document.getElementById('username');
        const photoInput = document.getElementById('photoInput');
        const logoPreview = document.getElementById('logoPreview');
        const uploadPhotoBtn = document.getElementById('uploadPhotoBtn');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const onlineCountSpan = document.getElementById('onlineCount');
        const userListDiv = document.getElementById('userList');
        const currentUserNameSpan = document.getElementById('currentUserName');
        const currentUserImg = document.getElementById('currentUserImg');
        const logoutBtn = document.getElementById('logoutBtn');

        // ================== LOGIN & FOTO ==================
        uploadPhotoBtn.addEventListener('click', () => {
            photoInput.click();
        });

        photoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    logoPreview.src = e.target.result;
                    logoPreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        loginBtn.addEventListener('click', async () => {
            const name = usernameInput.value.trim();
            if (!name) return alert('Isi nama dulu, goblok!');

            const photoFile = photoInput.files[0];
            let photoURL = 'https://www.gravatar.com/avatar/?d=mp'; // default

            if (photoFile) {
                try {
                    const reader = new FileReader();
                    const photoDataUrl = await new Promise((resolve) => {
                        reader.onload = () => resolve(reader.result);
                        reader.readAsDataURL(photoFile);
                    });
                    // Upload ke Firebase Storage pake base64
                    const storageRef = ref(storage, `avatars/${Date.now()}_${name}`);
                    await uploadString(storageRef, photoDataUrl, 'data_url');
                    photoURL = await getDownloadURL(storageRef);
                } catch (err) {
                    console.error('Gagal upload foto:', err);
                    alert('Foto gagal, pake default aja.');
                }
            }

            // Simpan user ke Firestore (pake uid random sementara)
            const uid = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            await setDoc(doc(db, 'users', uid), {
                name: name,
                photoURL: photoURL,
                lastSeen: serverTimestamp()
            });

            currentUser = { uid, name, photoURL };
            currentUserNameSpan.textContent = name;
            currentUserImg.src = photoURL;

            // Setup online status di Realtime DB
            const userStatusRef = dbRef(rtdb, 'status/' + uid);
            const connectedRef = dbRef(rtdb, '.info/connected');
            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    const con = push(userStatusRef);
                    onDisconnect(con).remove();
                    set(con, {
                        name: name,
                        photoURL: photoURL,
                        online: true,
                        timestamp: rtServerTimestamp()
                    });
                }
            });

            // Tampilkan chat
            loginContainer.style.display = 'none';
            chatContainer.style.display = 'flex';

            // Load messages
            if (unsubMessages) unsubMessages();
            const q = query(collection(db, 'messages'), orderBy('timestamp'));
            unsubMessages = onSnapshot(q, (snapshot) => {
                messagesDiv.innerHTML = '';
                snapshot.docs.forEach((doc) => {
                    const msg = doc.data();
                    appendMessage(msg);
                });
                scrollToBottom();
            });

            // Load online users
            const statusRef = dbRef(rtdb, 'status');
            onValue(statusRef, (snap) => {
                const data = snap.val();
                const onlineUsers = [];
                for (const uid in data) {
                    const lastCon = Object.values(data[uid] || {}).pop();
                    if (lastCon && lastCon.online) {
                        onlineUsers.push({ uid, ...lastCon });
                    }
                }
                onlineCountSpan.textContent = onlineUsers.length;
                userListDiv.innerHTML = onlineUsers.map(u => 
                    `<div class="user-item"><img src="${u.photoURL}" class="user-avatar-mini"> <span>${u.name}</span></div>`
                ).join('');
            });
        });

        // ================== KIRIM PESAN ==================
        sendBtn.addEventListener('click', async () => {
            const text = messageInput.value.trim();
            if (!text || !currentUser.uid) return;

            try {
                await addDoc(collection(db, 'messages'), {
                    text: text,
                    uid: currentUser.uid,
                    name: currentUser.name,
                    photoURL: currentUser.photoURL,
                    timestamp: serverTimestamp()
                });
                messageInput.value = '';
            } catch (err) {
                console.error('Gagal kirim:', err);
            }
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendBtn.click();
        });

        function appendMessage(msg) {
            const div = document.createElement('div');
            div.className = `message ${msg.uid === currentUser.uid ? 'own' : ''}`;
            div.innerHTML = `
                <img src="${msg.photoURL || 'https://www.gravatar.com/avatar/?d=mp'}" class="msg-avatar">
                <div class="msg-bubble">
                    <div class="msg-name">${msg.name}</div>
                    <div class="msg-text">${escapeHtml(msg.text)}</div>
                </div>
            `;
            messagesDiv.appendChild(div);
        }

        function escapeHtml(unsafe) {
            return unsafe.replace(/[&<>"]/g, function(m) {
                if (m === '&') return '&amp;';
                if (m === '<') return '&lt;';
                if (m === '>') return '&gt;';
                if (m === '"') return '&quot;';
                return m;
            });
        }

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // ================== LOGOUT ==================
        logoutBtn.addEventListener('click', () => {
            // Disconnect dari RTDB
            if (currentUser.uid) {
                const userStatusRef = dbRef(rtdb, 'status/' + currentUser.uid);
                set(userStatusRef, null); // hapus status
            }
            if (unsubMessages) unsubMessages();
            loginContainer.style.display = 'block';
            chatContainer.style.display = 'none';
            currentUser = { uid: null, name: null, photoURL: null };
            usernameInput.value = '';
            logoPreview.src = '';
            logoPreview.style.display = 'none';
            photoInput.value = '';
        });

    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: #0a0a0f; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        /* LOGIN */
        .login-box {
            background: #1a1a24; padding: 30px; border-radius: 32px; width: 380px;
            box-shadow: 0 20px 40px rgba(106, 13, 173, 0.3); border: 1px solid #6a0dad;
        }
        .login-box h2 { color: #b980ff; text-align: center; margin-bottom: 20px; font-weight: 700; letter-spacing: 1px; }
        .login-box input[type="text"] {
            width: 100%; padding: 14px; background: #0f0f1a; border: 2px solid #3a1b5e;
            border-radius: 40px; color: white; font-size: 16px; margin-bottom: 20px; outline: none;
        }
        .login-box input[type="file"] { display: none; }
        .photo-preview {
            display: flex; align-items: center; gap: 15px; background: #0f0f1a; padding: 10px 20px;
            border-radius: 60px; border: 2px solid #6a0dad; margin-bottom: 20px; cursor: pointer;
        }
        .photo-preview img { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 3px solid #b980ff; display: none; }
        .photo-preview span { color: #b980ff; font-weight: 600; }
        .login-btn {
            background: #6a0dad; color: white; border: none; padding: 16px; width: 100%;
            border-radius: 60px; font-weight: 800; font-size: 18px; cursor: pointer; transition: 0.2s;
            box-shadow: 0 5px 0 #38006b;
        }
        .login-btn:active { transform: translateY(5px); box-shadow: none; }

        /* CHAT CONTAINER */
        .chat-wrapper {
            display: flex; width: 1300px; max-width: 98vw; height: 95vh; background: #12121c;
            border-radius: 40px; overflow: hidden; border: 2px solid #6a0dad; box-shadow: 0 0 30px #7d3cff50;
        }
        /* SIDEBAR KIRI */
        .sidebar-left {
            width: 280px; background: #0b0b14; border-right: 2px solid #4a2c6e;
            display: flex; flex-direction: column;
        }
        .logo-area {
            padding: 20px; text-align: center; border-bottom: 1px solid #4a2c6e;
        }
        .logo-area img { width: 60px; height: 60px; border-radius: 30px; background: #6a0dad; padding: 8px; }
        .logo-area h3 { color: #c59bff; margin-top: 8px; }
        .online-header {
            padding: 16px; background: #1a1a2a; color: white; font-weight: bold;
            display: flex; justify-content: space-between; border-bottom: 1px solid #7a3fb0;
        }
        .online-count { background: #6a0dad; border-radius: 30px; padding: 2px 12px; font-size: 14px; }
        .user-list {
            flex: 1; overflow-y: auto; padding: 10px;
        }
        .user-item {
            display: flex; align-items: center; gap: 10px; color: #ddd; padding: 8px 10px;
            border-radius: 30px; background: #1f1f30; margin-bottom: 6px; border-left: 5px solid #b980ff;
        }
        .user-avatar-mini { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
        .current-user {
            border-top: 2px solid #5a2d8c; padding: 15px; background: #13131f; display: flex; align-items: center; gap: 10px;
        }
        .current-user img { width: 44px; height: 44px; border-radius: 50%; border: 3px solid #a35cff; }
        .current-user span { color: white; font-weight: 600; flex:1; }
        .logout-btn { background: none; border: 2px solid #7a3fb0; color: #c59bff; padding: 8px 16px; border-radius: 40px; cursor: pointer; }

        /* MAIN CHAT */
        .chat-main {
            flex: 1; display: flex; flex-direction: column; background: #0e0e16;
        }
        .chat-header {
            background: #1c1c2c; padding: 20px 25px; border-bottom: 3px solid #9a4eff;
            color: #d9b0ff; font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 12px;
        }
        .chat-header i { font-size: 28px; }
        .messages-area {
            flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 16px;
        }
        .message {
            display: flex; gap: 12px; max-width: 70%; animation: fade 0.2s;
        }
        .message.own { align-self: flex-end; flex-direction: row-reverse; }
        .msg-avatar { width: 42px; height: 42px; border-radius: 50%; border: 2px solid #9f5eff; }
        .msg-bubble {
            background: #25253b; padding: 12px 18px; border-radius: 24px 24px 24px 8px; color: white;
            box-shadow: 0 2px 10px #00000055; border: 1px solid #6d3f9e;
        }
        .message.own .msg-bubble {
            background: #6a0dad; color: white; border-radius: 24px 24px 8px 24px; border-color: #b980ff;
        }
        .msg-name { font-weight: 800; color: #cfadff; margin-bottom: 5px; font-size: 13px; }
        .message.own .msg-name { color: #ffd966; }
        .msg-text { word-wrap: break-word; font-size: 15px; }
        .input-area {
            display: flex; padding: 20px; background: #1a1a28; border-top: 2px solid #854ddb; gap: 12px;
        }
        .input-area input {
            flex: 1; background: #0a0a14; border: 2px solid #6236a4; border-radius: 60px; padding: 16px 20px;
            color: white; font-size: 16px; outline: none;
        }
        .input-area button {
            background: #6a0dad; border: none; width: 60px; height: 60px; border-radius: 60px;
            color: white; font-size: 26px; cursor: pointer; box-shadow: 0 4px 0 #38006b; transition: 0.05s linear;
            font-weight: bold;
        }
        .input-area button:active { transform: translateY(4px); box-shadow: none; }
        @keyframes fade { from{opacity:0;} to{opacity:1;} }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e1e2a; }
        ::-webkit-scrollbar-thumb { background: #9b5eff; border-radius: 20px; }
    </style>
</head>
<body>
    <!-- LOGIN PAGE -->
    <div id="loginContainer" class="login-box">
        <h2>ðŸ”¥ KILLER_VOIDS.CHAT</h2>
        <input type="text" id="username" placeholder="Nama lo..." maxlength="30">
        <div class="photo-preview" id="uploadPhotoBtn">
            <img id="logoPreview" src="">
            <span>ðŸ“¸ Upload foto profil (opsional)</span>
        </div>
        <input type="file" id="photoInput" accept="image/*">
        <button class="login-btn" id="loginBtn">GASKAN MASUK</button>
        <p style="color:#6a5a8a; text-align:center; margin-top: 20px;">dibikin jamin work âœ¨</p>
    </div>

    <!-- CHAT UTAMA (hidden at start) -->
    <div id="chatContainer" class="chat-wrapper" style="display: none;">
        <!-- SIDEBAR KIRI: logo, online, user list -->
        <div class="sidebar-left">
            <div class="logo-area">
                <img src="https://i.ibb.co.com/2dy5x7g/killer-voids-logo.png" alt="KILLER_LOGO" onerror="this.src='https://www.gravatar.com/avatar/?d=mp'">
                <h3>KILLER VOIDS</h3>
            </div>
            <div class="online-header">
                <span>ðŸ‘¥ Online</span>
                <span class="online-count" id="onlineCount">0</span>
            </div>
            <div class="user-list" id="userList">
                <!-- isi dari JS -->
            </div>
            <div class="current-user">
                <img id="currentUserImg" src="">
                <span id="currentUserName"></span>
                <button class="logout-btn" id="logoutBtn">ðŸšªEXIT</button>
            </div>
        </div>
        <!-- MAIN CHAT AREA -->
        <div class="chat-main">
            <div class="chat-header">
                <i>ðŸ’¬</i> PUBLIC ROOM Â· HITAM UNGU
            </div>
            <div class="messages-area" id="messages">
                <!-- pesan masuk sini -->
            </div>
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="Ketik pesan...">
                <button id="sendBtn">âž¤</button>
            </div>
        </div>
    </div>
</body>
</html>
